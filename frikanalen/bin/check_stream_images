#!/bin/sh
#
# Nagios test to detect a hanging video stream.
# Fetch two images from the Video stream and make sure they differ.
# Report error if they stay the same.

url="http://88.87.32.13:8080/"
delay=35 # seconds
tmpdir=.

getframe() {
    url="$1"
    filename="$2"
    mplayer -ss 0:00 -frames 1 -vo jpeg -nosound $url > /dev/null 2>&1
    mv 00000001.jpg $filename
}

getframe "$url" "$tmpdir/first.jpeg"
sleep $delay
getframe "$url" "$tmpdir/second.jpeg"

if findimagedupes $tmpdir/first.jpeg $tmpdir/second.jpeg | grep second.jpeg ; then
    rm $tmpdir/first.jpeg $tmpdir/second.jpeg
    echo "CRITICAL: Two images taken $delay seconds apart were (almost) identical"
    exit 2
else
    rm $tmpdir/first.jpeg $tmpdir/second.jpeg
    echo "OK: Two images taken $delay seconds apart differ"
    exit 0
fi
